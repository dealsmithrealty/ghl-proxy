worker_processes  1;

events { worker_connections 1024; }

http {
  client_max_body_size 50m;

  # So NGINX can talk TLS to upstream by hostname
  resolver 1.1.1.1 1.0.0.1 valid=300s;
  resolver_timeout 5s;

  # Pull subdomain: jeff.dealsmithrealty.com -> "jeff"
  map $host $sub {
    ~^(?<s>[^.]+)\.dealsmithrealty\.com$ $s;
    default "";
  }

  # Build origin host dynamically: <sub>.dsragent2025.net
  map $sub $origin {
    default "";
    ~.+       $sub.dsragent2025.net;
  }

  server {
    listen 8080;
    server_name ~^(?<anysub>[^.]+)\.dealsmithrealty\.com$;

    # Convenience vars
    set $brand         $host;      # e.g. jeff.dealsmithrealty.com
    set $origin_host   $origin;    # e.g. jeff.dsragent2025.net

    # -------- MAIN SITE --------
    location / {
      if ($origin_host = "") { return 404; }

      proxy_pass https://$origin_host;
      proxy_ssl_server_name on;

      # Keep users on your brand
      proxy_redirect https://$origin_host/ https://$brand/;

      # Make upstream cookies belong to your brand
      # NOTE: some NGINX builds donâ€™t like regex/variables here. If this line errors, use Config B below.
      proxy_cookie_domain $origin_host dealsmithrealty.com;

      # Rewrite absolute links, forms, scripts
      # NOTE: requires the std 'sub_filter' module (present in official nginx images).
      sub_filter_once off;
      sub_filter_types text/html text/css application/javascript application/json;
      sub_filter "https://$origin_host" "https://$brand";
      sub_filter "http://$origin_host"  "https://$brand";
      sub_filter "$origin_host"         "$brand";

      # Helpful headers
      proxy_set_header Host              $origin_host;
      proxy_set_header X-Forwarded-Host  $brand;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Real-IP         $remote_addr;

      # Remove headers that fight proxies
      proxy_hide_header Content-Security-Policy;
      proxy_hide_header Strict-Transport-Security;
      proxy_hide_header X-Frame-Options;
    }

    # -------- HL API same-origin proxy --------
    location /__hlapi/ {
      set $api_host api.msgsndr.com;

      rewrite ^/__hlapi/(.*)$ /$1 break;

      proxy_pass https://$api_host;
      proxy_ssl_server_name on;

      proxy_set_header Host              $api_host;
      proxy_set_header X-Forwarded-Host  $brand;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Real-IP         $remote_addr;

      proxy_redirect https://$api_host/ https://$brand/__hlapi/;
      # If this errors, comment it out and use B
      proxy_cookie_domain $api_host dealsmithrealty.com;

      proxy_hide_header Content-Security-Policy;
      proxy_hide_header Strict-Transport-Security;
      proxy_hide_header X-Frame-Options;
    }
  }
}
