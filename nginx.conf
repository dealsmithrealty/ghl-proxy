worker_processes  1;

events { worker_connections 1024; }

http {
  client_max_body_size 50m;

  # Let NGINX call HTTPS upstreams by hostname
  resolver 1.1.1.1 1.0.0.1 valid=300s;
  resolver_timeout 5s;

  # -------- JEFF --------
  server {
    listen 8080;
    server_name jeff.dealsmithrealty.com;

    # MAIN SITE
    location / {
      proxy_pass https://jeff.dsragent2025.net;
      proxy_ssl_server_name on;

      # Keep users on your branded domain
      proxy_redirect https://jeff.dsragent2025.net/ https://$host/;

      # Only rewrite inside HTML (not JS/JSON) to avoid /undefined
      proxy_set_header Accept-Encoding "";
      sub_filter_once off;
      sub_filter_types text/html;
      sub_filter "https://jeff.dsragent2025.net" "https://jeff.dealsmithrealty.com";
      sub_filter "http://jeff.dsragent2025.net"  "https://jeff.dealsmithrealty.com";

      # Helpful headers
      proxy_set_header Host              jeff.dsragent2025.net;
      proxy_set_header X-Forwarded-Host  $host;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Real-IP         $remote_addr;

      # Relax headers that can block proxying
      proxy_hide_header Content-Security-Policy;
      proxy_hide_header Strict-Transport-Security;
      proxy_hide_header X-Frame-Options;
    }

    # HL API same-origin proxy (forms/calendars)
    location /__hlapi/ {
      set $api_host api.msgsndr.com;
      rewrite ^/__hlapi/(.*)$ /$1 break;

      proxy_pass https://$api_host;
      proxy_ssl_server_name on;

      proxy_set_header Host              $api_host;
      proxy_set_header X-Forwarded-Host  $host;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Real-IP         $remote_addr;

      proxy_redirect https://$api_host/ https://$host/__hlapi/;

      proxy_hide_header Content-Security-Policy;
      proxy_hide_header Strict-Transport-Security;
      proxy_hide_header X-Frame-Options;
    }
  }

  # -------- JONMARES --------
  server {
    listen 8080;
    server_name jonmares.dealsmithrealty.com;

    location / {
      proxy_pass https://jonmares.dsragent2025.net;
      proxy_ssl_server_name on;
      proxy_redirect https://jonmares.dsragent2025.net/ https://$host/;

      proxy_set_header Accept-Encoding "";
      sub_filter_once off;
      sub_filter_types text/html;
      sub_filter "https://jonmares.dsragent2025.net" "https://jonmares.dealsmithrealty.com";
      sub_filter "http://jonmares.dsragent2025.net"  "https://jonmares.dealsmithrealty.com";

      proxy_set_header Host              jonmares.dsragent2025.net;
      proxy_set_header X-Forwarded-Host  $host;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Real-IP         $remote_addr;

      proxy_hide_header Content-Security-Policy;
      proxy_hide_header Strict-Transport-Security;
      proxy_hide_header X-Frame-Options;
    }

    location /__hlapi/ {
      set $api_host api.msgsndr.com;
      rewrite ^/__hlapi/(.*)$ /$1 break;

      proxy_pass https://$api_host;
      proxy_ssl_server_name on;

      proxy_set_header Host              $api_host;
      proxy_set_header X-Forwarded-Host  $host;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Real-IP         $remote_addr;

      proxy_redirect https://$api_host/ https://$host/__hlapi/;

      proxy_hide_header Content-Security-Policy;
      proxy_hide_header Strict-Transport-Security;
      proxy_hide_header X-Frame-Options;
    }
  }

  # -------- DREW --------
  server {
    listen 8080;
    server_name drew.dealsmithrealty.com;

    location / {
      proxy_pass https://drew.dsragent2025.net;
      proxy_ssl_server_name on;
      proxy_redirect https://drew.dsragent2025.net/ https://$host/;

      proxy_set_header Accept-Encoding "";
      sub_filter_once off;
      sub_filter_types text/html;
      sub_filter "https://drew.dsragent2025.net" "https://drew.dealsmithrealty.com";
      sub_filter "http://drew.dsragent2025.net"  "https://drew.dealsmithrealty.com";

      proxy_set_header Host              drew.dsragent2025.net;
      proxy_set_header X-Forwarded-Host  $host;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Real-IP         $remote_addr;

      proxy_hide_header Content-Security-Policy;
      proxy_hide_header Strict-Transport-Security;
      proxy_hide_header X-Frame-Options;
    }

    location /__hlapi/ {
      set $api_host api.msgsndr.com;
      rewrite ^/__hlapi/(.*)$ /$1 break;

      proxy_pass https://$api_host;
      proxy_ssl_server_name on;

      proxy_set_header Host              $api_host;
      proxy_set_header X-Forwarded-Host  $host;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Real-IP         $remote_addr;

      proxy_redirect https://$api_host/ https://$host/__hlapi/;

      proxy_hide_header Content-Security-Policy;
      proxy_hide_header Strict-Transport-Security;
      proxy_hide_header X-Frame-Options;
    }
  }
}
