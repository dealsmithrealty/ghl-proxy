worker_processes  1;

events { worker_connections 1024; }

http {
  client_max_body_size 50m;

  # Let NGINX talk to HTTPS upstreams by hostname
  resolver 1.1.1.1 1.0.0.1 valid=300s;
  resolver_timeout 5s;

  # Get subdomain: jeff.dealsmithrealty.com -> "jeff"
  map $host $sub {
    ~^(?<s>[^.]+)\.dealsmithrealty\.com$ $s;
    default "";
  }

  # Build origin host dynamically: <sub>.dsragent2025.net
  map $sub $origin {
    default "";
    ~.+       $sub.dsragent2025.net;
  }

  server {
    listen 8080;
    # Match ANY subdomain under dealsmithrealty.com
    server_name ~^(?<anysub>[^.]+)\.dealsmithrealty\.com$;

    # Convenience
    set $brand       $host;        # e.g. jeff.dealsmithrealty.com
    set $origin_host $origin;      # e.g. jeff.dsragent2025.net

    # -------- MAIN SITE (pages/assets) --------
    location / {
      if ($origin_host = "") { return 404; }

      proxy_pass https://$origin_host;
      proxy_ssl_server_name on;

      # Keep users on your branded domain
      proxy_redirect https://$origin_host/ https://$brand/;

      # Make upstream cookies belong to your brand (helps forms/auth)
      proxy_cookie_domain $origin_host dealsmithrealty.com;

      # IMPORTANT: Only rewrite in HTML (avoid touching JS/JSON to prevent /undefined)
      # Also, tell upstream not to gzip so sub_filter can see the HTML.
      proxy_set_header Accept-Encoding "";

      sub_filter_once off;
      sub_filter_types text/html;           # <â€” restrict to HTML only
      sub_filter "https://$origin_host" "https://$brand";
      sub_filter "http://$origin_host"  "https://$brand";

      # Forward helpful headers
      proxy_set_header Host              $origin_host;
      proxy_set_header X-Forwarded-Host  $brand;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Real-IP         $remote_addr;

      # Remove headers that can block proxy
      proxy_hide_header Content-Security-Policy;
      proxy_hide_header Strict-Transport-Security;
      proxy_hide_header X-Frame-Options;
    }

    # -------- HL API same-origin proxy (forms/calendars) --------
    # Your pages can call /__hlapi/* on your domain instead of api.msgsndr.com
    location /__hlapi/ {
      set $api_host api.msgsndr.com;

      rewrite ^/__hlapi/(.*)$ /$1 break;

      proxy_pass https://$api_host;
      proxy_ssl_server_name on;

      proxy_set_header Host              $api_host;
      proxy_set_header X-Forwarded-Host  $brand;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Real-IP         $remote_addr;

      proxy_redirect https://$api_host/ https://$brand/__hlapi/;
      proxy_cookie_domain $api_host dealsmithrealty.com;

      proxy_hide_header Content-Security-Policy;
      proxy_hide_header Strict-Transport-Security;
      proxy_hide_header X-Frame-Options;
    }
  }
}
