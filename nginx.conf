worker_processes  1;

events { worker_connections 1024; }

http {
  # Big enough for form/file posts
  client_max_body_size 50m;

  # Needed so nginx can reach HTTPS upstreams by hostname
  resolver 1.1.1.1 1.0.0.1 valid=300s;
  resolver_timeout 5s;

  # Map your branded host to the real HighLevel host (easy to extend later)
  map $host $origin_host {
    default jeff.dsragent2025.net;
  }

  server {
    # Railway listens on a single HTTP port
    listen 8080;
    server_name jeff.dealsmithrealty.com;

    # For convenience
    set $brand  $host;          # jeff.dealsmithrealty.com
    set $origin $origin_host;   # jeff.dsragent2025.net

    # -------- MAIN SITE (HTML/JS/CSS/assets) --------
    location / {
      proxy_pass https://$origin;
      proxy_ssl_server_name on;

      # Keep users on your brand domain
      proxy_redirect https://$origin/ https://$brand/;

      # Make cookies belong to your domain (so forms/auth stick)
      proxy_cookie_domain ~$origin dealsmithrealty.com;

      # Rewrite links, scripts, forms, and any plain host mentions
      sub_filter_once off;
      sub_filter_types text/html text/css application/javascript application/json;
      sub_filter "https://$origin" "https://$brand";
      sub_filter "http://$origin"  "https://$brand";
      sub_filter "$origin"         "$brand";

      # Forward useful headers
      proxy_set_header Host              $origin;
      proxy_set_header X-Forwarded-Host  $brand;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Real-IP         $remote_addr;

      # HL sometimes sends headers that fight proxying â€” hide them
      proxy_hide_header Content-Security-Policy;
      proxy_hide_header Strict-Transport-Security;
      proxy_hide_header X-Frame-Options;
    }

    # -------- HL API SAME-ORIGIN PROXY (forms/calendars) --------
    # Your pages may call https://api.msgsndr.com/*.
    # With this, they can call /__hlapi/* on your domain instead.
    location /__hlapi/ {
      set $api_host api.msgsndr.com;

      # Map /__hlapi/<rest> -> https://api.msgsndr.com/<rest>
      rewrite ^/__hlapi/(.*)$ /$1 break;

      proxy_pass https://$api_host;
      proxy_ssl_server_name on_
