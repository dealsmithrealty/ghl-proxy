worker_processes 1;

events { worker_connections 1024; }

http {
  client_max_body_size 50m;
  resolver 1.1.1.1 1.0.0.1 valid=300s;

  server {
    # Railway expects your app to listen on one port. Use 8080.
    listen 8080;
    server_name jeff.dealsmithrealty.com;

    # -------- Public site (pages/assets) --------
    location / {
      # Send traffic to the real HL site
      proxy_pass https://jeff.dsragent2025.net;
      proxy_ssl_server_name on;                 # SNI for HTTPS upstream

      # Keep the URL branded
      proxy_redirect https://jeff.dsragent2025.net/ https://$host/;

      # Make cookies stick to your domain
      proxy_cookie_domain jeff.dsragent2025.net dealsmithrealty.com;

      # Rewrite absolute links in HTML/CSS/JS
      sub_filter_once off;
      sub_filter_types text/html text/css application/javascript;
      sub_filter "https://jeff.dsragent2025.net" "https://$host";
      sub_filter "http://jeff.dsragent2025.net"  "https://$host";

      # Relax headers that block proxying
      proxy_hide_header Content-Security-Policy;
      proxy_hide_header Strict-Transport-Security;
      proxy_hide_header X-Frame-Options;

      # Forward proto/host (optional but fine)
      proxy_set_header Host jeff.dsragent2025.net;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Real-IP $remote_addr;
    }

    # -------- HL API same-origin proxy (avoids CORS) --------
    # If your forms/widgets call https://api.msgsndr.com/*, theyâ€™ll instead hit:
    # https://jeff.dealsmithrealty.com/__hlapi/*
    location /__hlapi/ {
      set $api_host api.msgsndr.com;

      # Map /__hlapi/<rest> -> https://api.msgsndr.com/<rest>
      rewrite ^/__hlapi/(.*)$ /$1 break;

      proxy_set_header Host $api_host;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Real-IP $remote_addr;

      proxy_pass https://$api_host;
      proxy_ssl_server_name on;

      proxy_redirect https://$api_host/ https://$host/__hlapi/;
      proxy_cookie_domain $api_host dealsmithrealty.com;

      proxy_hide_header Content-Security-Policy;
      proxy_hide_header Strict-Transport-Security;
      proxy_hide_header X-Frame-Options;
    }
  }
}
